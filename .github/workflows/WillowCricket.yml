name: CI

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Build Docker image
        run: |
          docker build -t cricket-tv-live-gui -f dockerfile .

      - name: Run Docker container
        run: |
          docker run -d --name cricket-tv-live-gui -e DISPLAY=:0 cricket-tv-live-gui

      - name: Install VLC and run command
        run: |
          docker exec -it cricket-tv-live-gui bash -c "
          sudo apt-get update && 
          sudo apt-get install -y vlc && 
          useradd -ms /bin/bash unroot &&
          echo 'unroot:password' | chpasswd &&
          sudo -u unroot cvlc \"http://xtv.ooo:8080/5514168769/3198259801/219689\" \
          --sout \"#transcode{vcodec=h264,vb=300,scale=1,height=360,fps=20,acodec=mp4a,ab=48,channels=2,samplerate=44100}:duplicate{dst=std{access=livehttp{seglen=30,delsegs=true,numsegs=5,index=360p.m3u8,index-url=/360p-########.ts},mux=ts,dst=360p-########.ts}}\" \
          --sout \"#transcode{vcodec=h264,vb=500,scale=1,height=480,fps=20,acodec=mp4a,ab=64,channels=2,samplerate=44100}:duplicate{dst=std{access=livehttp{seglen=30,delsegs=true,numsegs=5,index=480p.m3u8,index-url=/480p-########.ts},mux=ts,dst=480p-########.ts}}\" \
          --sout \"#transcode{vcodec=h264,vb=1500,scale=1,height=720,fps=20,acodec=mp4a,ab=96,channels=2,samplerate=44100}:duplicate{dst=std{access=livehttp{seglen=30,delsegs=true,numsegs=5,index=720p.m3u8,index-url=/720p-########.ts},mux=ts,dst=720p-########.ts}}\" \
          --no-dbus --no-video-title-show --no-audio --loop"
